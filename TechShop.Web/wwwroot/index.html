<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>TechShop.Web</title>
    <base href="/" />
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link href="css/app.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="TechShop.Web.styles.css" rel="stylesheet" />

   



    <!--link c·ªßa map-->
    <link rel="stylesheet" href="./DiaLy/css/leaflet.css">
    <link rel="stylesheet" href="./DiaLy/css/map_style.css">

</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">üóô</a>
    </div>

    <script src="_framework/blazor.webassembly.js"></script>

    <!--<script src="_framework/blazor.server.js"></script>-->
    <!--ShoppingCart-->
    <script src="/assets/js/ShoppingCartFunction.js"></script>


    <script src="./DiaLy/js/leaflet.js"></script>
    <script src="./DiaLy/js/jquery-3.7.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" integrity="sha512-ozq8xQKq6urvuU6jNgkfqAmT7jKN2XumbrX1JiB3TnF7tI48DPI4Gy1GXKD/V3EExgAs1V+pRO7vwtS1LHg0Gw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw-src.css" integrity="sha512-vJfMKRRm4c4UupyPwGUZI8U651mSzbmmPgR3sdE3LcwBPsdGeARvUM5EcSTg34DK8YIRiIo+oJwNfZPMKEQyug==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script>
        function initialize() {
            //Khai b√°o ƒë·ªëi t∆∞·ª£ng ch√≠nh ch·ª©a b·∫£n ƒë·ªì g·∫Øn v√†o th·∫ª div t√™n "map"
            var mapObject = L.map("map", { center: [10.030249, 105.772097], zoom: 17 });
            //ho·∫∑c: var mapObject = L.map('map').setView([10.030249, 105.772097], 17);

            //B·∫£n ƒë·ªì n·ªÅn d·∫°ng Raster
            L.tileLayer(
                "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                {
                    attribution: '&copy; <a href="http://' +
                        'www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }
            ).addTo(mapObject);

            var layerObject = L.layerGroup().addTo(mapObject);

            var combobox = L.control({ position: "topleft" });
            combobox.onAdd = function (map) {
                var div = L.DomUtil.create("div", "");
                div.innerHTML = '<select id="combobox"></select>';
                return div;
            };
            combobox.addTo(mapObject);

            var urlJSON = "https://localhost:44368/api/Map/GetData";
            var sql = "?q=ALL";
            $.getJSON(urlJSON + sql, function (data) {
                var menu = $("#combobox");
                menu.append("<option data-id='ALL'>T·∫•t c·∫£</option>");
                $.each(data.features, function (key, value) {
                    menu.append("<option data-id=" + value.id + ">" + value.properties.name + "</option>");
                });

                var lineStyle = { color: "blue", weight: 4 };
                var polygonStyle = { color: "red", fillColor: "yellow", weight: 4 };
                L.geoJSON(data, {
                    style: function (feature) {
                        switch (feature.geometry.type) {
                            case 'LineString': return lineStyle;
                            case 'Polygon': return polygonStyle;
                        }
                    },
                    onEachFeature: function (feature, layer) {
                        if (feature.properties && feature.properties.name) {
                            layer.bindPopup("<i>" + feature.properties.name + "</i>");
                        }
                    }
                }).addTo(layerObject);
            });

            $("#combobox").on("change", function () {
                var valueSelected = $("#combobox option:selected").data("id");
                if (valueSelected == "ALL") {
                    sql = "?q=ALL";
                } else {
                    sql = "?q=" + valueSelected;
                }

                $.getJSON(urlJSON + sql, function (data) {
                    layerObject.clearLayers();

                    var lineStyle = { color: "blue", weight: 4 };
                    var polygonStyle = { color: "red", fillColor: "yellow", weight: 4 };
                    L.geoJSON(data, {
                        style: function (feature) {
                            switch (feature.geometry.type) {
                                case 'LineString': return lineStyle;
                                case 'Polygon': return polygonStyle;
                            }
                        },
                        onEachFeature: function (feature, layer) {
                            if (feature.properties && feature.properties.name) {
                                layer.bindPopup("<i>" + feature.properties.name + "</i>");
                            }
                        }
                    }).addTo(layerObject);
                })
            });

            //draw

            //khai b√°o featuregroup ƒë·ªÉ v·∫Ω
            var drawnItems = L.featureGroup().addTo(mapObject);

            //ƒë·ªãnh nghƒ©a marker kh√°c m·∫∑c nhi√™n
            var MyCustomMarker = L.Icon.extend({
                options: {
                    shadowUrl: null,
                    iconAnchor: new L.Point(13, 41),
                    iconSize: [25, 41],			//new gi·ªëng tr√™n c≈©ng ƒë∆∞·ª£c
                    iconUrl: 'css/images/redicon.png'
                }
            });

            //C√°c option cho c√¥ng c·ª• v·∫Ω
            var options = {
                position: 'topleft',			//default 'topleft'
                draw: {
                    polyline: {
                        shapeOptions: {
                            color: '#f357a1',
                            weight: 2
                        },
                        metric: true				//default true l√† met; false l√† foot
                    },
                    polygon: {
                        shapeOptions: {
                            color: '#bada55'
                        },
                        showArea: true,			//default false
                    },
                    rectangle: {
                        shapeOptions: {
                            color: 'green',
                            weight: 2,
                            fillColor: 'blue',
                            fillOpacity: 0.2		//ƒë·ªô m·ªù, default 0.2
                        }
                    },
                    marker: {
                        icon: new MyCustomMarker()
                    },
                    circle: true,
                    circlemarker: false, 		// Turns off this drawing tool
                },
                edit: {
                    featureGroup: drawnItems, 	//REQUIRED!!
                    edit: true,
                    remove: true,
                }
            };

            //Th√™m ƒëi·ªÅu khi·ªÉn v·∫Ω; Icon m·∫∑c nhi√™n trong th∆∞ m·ª•c css/images
            var drawControl = new L.Control.Draw(options).addTo(mapObject);

            //Khi v·∫Ω th√¨ th√™m v√†o l·ªõp drawnItems
            function showText(e) {
                //drawnItems.clearLayers();
                var layer = e.layer;
                console.log(layer.toGeoJSON());
                layer.addTo(drawnItems);
                //collection d·∫°ng object
                var collection = drawnItems.toGeoJSON();
                //null: kh√¥ng h√†m x·ª≠ l√Ω, 2: th·ª•t t·ª´ng c·∫•p l√† 2 kho·∫£ng tr·∫Øng
                var geojson1 = JSON.stringify(collection, null, 2);
                $("#geojsontext1").val(geojson1);
                //JSON.stringify chuy·ªÉn object th√†nh chu·ªói JSON
                var geojson2 = JSON.stringify(layer.toGeoJSON().geometry, null, 2);
                $("#geojsontext2").val(geojson2);
            }

            //Khi m·ªôt ƒë·ªëi t∆∞·ª£ng ƒë∆∞·ª£c v·∫Ω
            mapObject.on("draw:created", showText);

            //V·∫Ω t·ª´ FeatureCollection
            $("#submit1").on("click", function () {
                drawnItems.clearLayers();
                //JSON.parse chuy·ªÉn chu·ªói JSON th√†nh ƒë·ªëi t∆∞·ª£ng Javascript
                L.geoJSON(JSON.parse($("#geojsontext1").val())).addTo(drawnItems);
            });

            //V·∫Ω t·ª´ m·ªôt feature
            $("#submit2").on("click", function () {
                drawnItems.clearLayers();
                L.geoJSON(JSON.parse($("#geojsontext2").val())).addTo(drawnItems);
            });


        }

    </script>


</body>

</html>
